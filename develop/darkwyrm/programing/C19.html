

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>第十九课 &mdash; Haiku 中文文档</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Haiku 中文文档" href="../../../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../../index.html" class="icon icon-home"> Haiku Chinese Documents
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../关于Haiku.html">关于 Haiku</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../关于Haiku.html#id1">Haiku 好处在哪儿？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../关于Haiku.html#id2">为何选择 Haiku ？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../关于Haiku.html#id3">谁支持着 Haiku ？</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../开发.html">开发</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../开发.html#id2">用户指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../开发.html#id3">开发文档</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../开发入门.html">开发入门</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../开发入门.html#id2">手册相关</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发入门.html#id3">入门任务</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发入门.html#id4">当您找到任务</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发入门.html#id5">编写代码准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发入门.html#git">获取 GIT 提交权限</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发入门.html#id6">深入阅读</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../Haiku编程学习.html">Haiku编程学习</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku编程学习.html#id1">简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku编程学习.html#id2">目录</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku编程学习.html#id3">参考资料和工具</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../Haiku编程教程.html">Haiku 编程详解</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku编程教程.html#id1">前言</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku编程教程.html#id2">内容概览</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../Haiku指南.html">Haiku 指南</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku指南.html#guides-haiku"><code class="docutils literal"><span class="pre">/guides/构建Haiku</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku指南.html#id1"><code class="docutils literal"><span class="pre">/guides/安装Haiku</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku指南.html#id2"><code class="docutils literal"><span class="pre">/guides/启动Haiku</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku指南.html#guides"><code class="docutils literal"><span class="pre">/guides/日常任务</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku指南.html#id3"><code class="docutils literal"><span class="pre">/guides/虚拟化</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku指南.html#id4">其他指南</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../Haiku源码规范.html">Haiku 编码规范</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id2">规范概况</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id3">缩进和空格</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id4">杂项</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id5">标识符</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id6">变量声明</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#haiku-api">使用 Haiku 内置的 API，类型等</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id7">注释</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id8">许可和版权</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id9">无用代码和调试代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id10">其他的要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Haiku源码规范.html#id11">风格检查工具</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../开发常见问题（FAQ）.html">开发常见问题（FAQ）</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id1">我是一个程序员，希望可以帮忙，那么从何开始呢？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id4">是否有简单的引导任务？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id6">是否有特定的编程风格？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id7">如何创建和提交补丁？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#trac">为什么无法在 Trac 中创建任务单？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id8">使用哪些开发工具？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id9">是否有开发者邮件列表？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#irc">是否有 IRC 聊天室？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id10">我尝试进行测试，但是 Haiku 编译失败。接下来该如何操作？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#id11">我想把一些东西集成到官方源之中，可以集成那些组件？该使用何种协议呢？</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../开发常见问题（FAQ）.html#beos-haiku">我希望可以把我的 BeOS 程序/驱动移植到 Haiku，该如何进行？</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Haiku图标指南.html">Haiku 图标指南</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id1">透视效果</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id2">光源效果</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id3">渐变效果</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id4">色彩效果</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id5">阴影效果</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id6">轮廓线</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id7">高亮效果</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id8">使用覆盖</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id9">细节</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Haiku图标指南.html#id10">中立图标</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../开发.html#id4">在线资源</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../开发.html#id7">开发工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../开发.html#id8">其他系统交叉编译</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../文档.html">文档</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../文档.html#id2">用户文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../文档.html#id3">开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../文档.html#id4">早期文档</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../文档.html#bebook-be">BeBook 和 Be 信札</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../文档.html#id5">其他</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Haiku Chinese Documents</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
    <li>第十九课</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="id1">
<h1><a class="toc-backref" href="#id6">第十九课</a><a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="contents topic" id="id2">
<p class="topic-title first">内容</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id6">第十九课</a><ul>
<li><a class="reference internal" href="#haiku" id="id7">详解 Haiku 消息</a></li>
<li><a class="reference internal" href="#c" id="id8">C++ 脚本</a></li>
<li><a class="reference internal" href="#id3" id="id9">实现脚本支持</a><ul>
<li><a class="reference internal" href="#resolvespecifier-1-looper" id="id10">ResolveSpecifier()方法1：远程 Looper 中的处理程序</a></li>
<li><a class="reference internal" href="#resolvespecifier-2-looper" id="id11">ResolveSpecifier()方法2：当前 Looper 中的处理函数</a></li>
<li><a class="reference internal" href="#resolvespecifier-3" id="id12">ResolveSpecifier()方法3：解析</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4" id="id13">思路总结</a></li>
<li><a class="reference internal" href="#id5" id="id14">深入了解</a></li>
</ul>
</li>
</ul>
</div>
<p>在上节课中，我们介绍了 Haiku 的脚本 API，例如如何通过 hey 终端命令进行操作。那么这节课我们将继续深入，了解使用 C++ 构建脚本的机制。</p>
<div class="section" id="haiku">
<h2><a class="toc-backref" href="#id7">详解 Haiku 消息</a><a class="headerlink" href="#haiku" title="永久链接至标题">¶</a></h2>
<p>首先，通过脚本 API 使用 C++ 来操作其他程序的想法乍看之下，毫无头绪，但是我们有理由这么做。其中之一就是它所带来的巨大便利。hey 具有自身的限制，其中最重要的原因是它不具有执行命令的能力，并且需要摒弃一些数据以迎合 bash 命令解析。使用 C++ 来构建脚本需要对 Haiku API 的消息类的了解更为深入，而非流于表面，但是它也通过脚本接口带来了强大的功能。</p>
<p>多数 GUI 开发并不会过多的涉及到消息处理类，因为 API 都已经非常完备。多数情况下，我们对应于消息，仅仅明确的发送一次。那么让我们快速的浏览一下那些用于脚本的消息处理类。</p>
<p>BHandler 和 BLooper 完成了消息处理的大部分工作。BHandler 对消息作出响应。BLooper 接收消息，并将其传递给附属的 BHandler 列表，直到它们其中之一对消息作出某些动作，因为 BLooper 是 BHandler 的子类，BLooper 也可以对消息作出响应。多数情况下，当发送消息到 BWindow 及其基于 BView 的控件时，才会发生，BWindow 是 BLooper 的子类，而 BView 是 BHandler 的直接子类。</p>
<p>BMessenger 是用以传递这些四处发送的脚本消息的方法。它的对象可能是 BLooper 或者 BHandler，并且提供了一种发送消息到这些对象的方式，而不管对象时在您的程序或者是系统中的其他地方。</p>
</div>
<div class="section" id="c">
<h2><a class="toc-backref" href="#id8">C++ 脚本</a><a class="headerlink" href="#c" title="永久链接至标题">¶</a></h2>
<p>使用 C++ 来构建脚本与使用 hey 并无很大区别。虽然需要很多的输入，但其内容基本完全一样：每个 hey 命令都是一个单独的消息，而命令仅仅是 BMessage 的 what 属性，而其他的则是供 BMessage 对应方法所处理的说明符。</p>
<p>我们从转译一个hey命令开始，相比于 C++，它提供了对用户更加友好的接口。如下：</p>
<div class="highlight-sh"><div class="highlight"><pre>hey StyledEdit get Title of Window 1
</pre></div>
</div>
<p>该命令要求 StyledEdit 提供它的首个文档窗口的标题。需要使用的数据有三个部分：目标对象，脚本动作，以及说明符列表。发送消息的代码如下：</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="cp">#include &lt;Message.h&gt;</span>
<span class="cp">#include &lt;Messenger.h&gt;</span>
<span class="cp">#include &lt;String.h&gt;</span>

<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">status_t</span> <span class="n">status</span><span class="p">;</span>
        <span class="c1">// 将 messenger 指向 StyledEdit 应用。如果StyledEdit未运行，</span>
        <span class="c1">// status 参数用以获取错误条件。</span>
        <span class="n">BMessenger</span> <span class="n">messenger</span><span class="p">(</span><span class="s">&quot;application/x-vnd.Haiku-StyledEdit&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="c1">// 设置命令</span>
                <span class="n">BMessage</span> <span class="n">msg</span><span class="p">(</span><span class="n">B_GET_PROPERTY</span><span class="p">),</span> <span class="n">reply</span><span class="p">;</span>

                <span class="c1">// 设置说明符。需要注意的是，和hey命令相似，</span>
                <span class="c1">// 它们按照从最常用至最少用的次序排列。</span>
                <span class="n">msg</span><span class="p">.</span><span class="n">AddSpecifier</span><span class="p">(</span><span class="s">&quot;Title&quot;</span><span class="p">);</span>
                <span class="n">msg</span><span class="p">.</span><span class="n">AddSpecifier</span><span class="p">(</span><span class="s">&quot;Window&quot;</span><span class="p">,</span> <span class="mi">1L</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">messenger</span><span class="p">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">)</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                <span class="p">{</span>
                        <span class="c1">// 任何时候脚本消息返回的错误都是</span>
                        <span class="c1">// 常量 B_MESSAGE_NOT_UNDERSTOOD。</span>
                        <span class="n">BString</span> <span class="n">title</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">FindString</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">title</span><span class="p">)</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Title of StyledEdit Window 1: %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">.</span><span class="n">String</span><span class="p">());</span>
                        <span class="k">else</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t get title of StyledEdit Window&quot;</span> <span class="s">&quot;1 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;StyledEdit does not appear to be running. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如你所见，即便会多些输入，但是通过 C++ 来发送命令并不是太过困难。而理解 Haiku 的脚本原理和实现方式则是最困难的部分。其中也涉及到了从目标对象获取 suite，但它并不困难。下述的代码用于从 StyledEdit 的首个窗口中获取处理的 suite，并将其歇息，然后以简短，并且接近英语的格式打印。请看代码：</p>
<div class="highlight-cpp"><div class="highlight"><pre>#include &lt;Message.h&gt;
#include &lt;Messenger.h&gt;
#include &lt;PropertyInfo.h&gt;
#include &lt;String.h&gt;

#include &lt;stdio.h&gt;

int
main(void)
{
        // “hey StyledEdit get Suites of Window 1”的C++版本
        status_t status;
        BMessenger messenger(&quot;application/x-vnd.Haiku-StyledEdit&quot;, -1, &amp;status);
        if (status == B_OK)
        {
                BMessage msg(B_GET_PROPERTY), reply;
                msg.AddSpecifier(&quot;Suites&quot;);
                msg.AddSpecifier(&quot;Window&quot;, 1L);
                if (messenger.SendMessage(&amp;msg, &amp;reply) == B_OK)
                {
                        // 我们已经获取到了suite，下面开始进行解析并将其
                        // 以一种比BPropertyInfo.PrintToStream()分离内容更易
                        // 理解的格式打印出来。
                        int32 i = 0;
                        BString suiteName;
                        BPropertyInfo propInfo;
                        while (reply.FindString(&quot;suites&quot;, i, &amp;suiteName) == B_OK)
                        {
                                printf( &quot;Suite %s:\n&quot;, suiteName.String());
                                if (reply.FindFlat(“message”, i, &amp;propInfo) != B_OK)
                                {
                                        i++;
                                        continue;
                                }


                                int32 propCount = propInfo.CountProperties();
                                const property_info* info = propInfo.Properties();

                                for (int32 j = 0; j &lt; propCount; j++)
                                {
                                        BString commands, specifiers;

                                        int32 cmdIndex = 0;
                                        if (info[j].commands[0] == 0)
                                                commands = &quot;Get, Set, Count,&quot;
                                                                &quot;Create, Delete&quot;;
                                        else
                                                while (info[j].commands[cmdIndex])
                                                {
                                                        BString cmdLabel;
                                                        switch (info[j].commands[cmdIndex])
                                                        {
                                                                case B_COUNT_PRPERTIES:
                                                                {
                                                                        cmdLabel = &quot;Count&quot;;
                                                                        break;
                                                                }
                                                                case B_CREATE_PRPERTIES:
                                                                {
                                                                        cmdLabel = &quot;Create&quot;;
                                                                        break;
                                                                }
                                                                case B_DELETE_PRPERTIES:
                                                                {
                                                                        cmdLabel = &quot;Delete&quot;;
                                                                        break;
                                                                }
                                                                case B_EXECUTE_PRPERTIES:
                                                                {
                                                                        cmdLabel = &quot;Execute&quot;;
                                                                        break;
                                                                }
                                                                case B_GET_PRPERTIES:
                                                                {
                                                                        cmdLabel = &quot;Get&quot;;
                                                                        break;
                                                                }
                                                                case B_SET_PRPERTIES:
                                                                {
                                                                        cmdLabel = &quot;Set&quot;;
                                                                        break;
                                                                }
                                                                default:
                                                                        break;
                                                        }
                                                        if (cmdLabel.CountChars())
                                                        {
                                                                if (cmdIndex &gt; 0 &amp;&amp;
                                                                        commands.CountChars() &gt; 0)
                                                                        commands &lt;&lt; &quot;,&quot;;
                                                                commands &lt;&lt; cmdLabel;
                                                        }

                                                        cmdIndex++;
                                                } // 结束 while (commands)
                                        if (commands.CountChars() == 0)
                                                commands = &quot;None&quot;;

                                        int32 specIndex = 0;
                                        if (info[j].specifiers[0] == 0)
                                                specifiers = &quot;All&quot;;
                                        else
                                                while (info[j].specifiers[specIndex])
                                                {
                                                        BString label;
                                                        switch (info[j].specifiers[specIndex])
                                                        {
                                                                case B_DIRECT_SPECIFIER:
                                                                {
                                                                        label = &quot;Direct&quot;;
                                                                        break;
                                                                }
                                                                case B_NAME_SPECIFIER:
                                                                {
                                                                        label = &quot;Name&quot;;
                                                                        break;
                                                                }
                                                                case B_ID_SPECIFIER:
                                                                {
                                                                        label = &quot;ID&quot;;
                                                                        break;
                                                                }
                                                                case B_INDEX_SPECIFIER:
                                                                {
                                                                        label = &quot;Index&quot;;
                                                                        break;
                                                                }
                                                                case B_REVERSE_INDEX_SPECIFIER:
                                                                {
                                                                        label = &quot;ReverseIndex&quot;;
                                                                        break;
                                                                }
                                                                case B_RANGE_SPECIFIER:
                                                                {
                                                                        label = &quot;Range&quot;;
                                                                        break;
                                                                }
                                                                case B_REVERSE_RANGE_SPECIFIER:
                                                                {
                                                                        label = &quot;RverseRange&quot;;
                                                                        break;
                                                                }
                                                                default:
                                                                {
                                                                        break;
                                                                }

                                                        }

                                                        if (label.CountChars())
                                                        {
                                                                if (specINdex &gt; 0 &amp;&amp;
                                                                                specifiers.CountChars() &gt; 0)
                                                                        specifiers &lt;&lt; &quot;,&quot;;
                                                                specifiers &lt;&lt; label;
                                                        }

                                                        specIndex++;
                                                }   // 结束 while(specifiers)
                                        if (specifiers.CountChars() == 0)
                                                specifiers = &quot;None&quot;;

                                        printf(&quot;%s: %s (%s)\n&quot;, info[j].name,
                                                        commands.String(), specifiers.String());

                                        if (info[j].usage &amp;&amp; strlen(info[j].usage) &gt; 0)
                                                printf(&quot;\t%s\n&quot;, info[j].usage);
                                } //所有属性结束

                                printf(&quot;\n&quot;);

                                i++;
                        } //结束每个suite
                } //结束每个suite名称的while循环
        } //结束 if status == B_OK
        else
                printf(&quot;StyledEdit does not appear to be running.\n&quot;);

        return 0;
}
</pre></div>
</div>
<p>我们已经对代码讨论了很多，但这并没有说明很多问题。这是 Haiku 脚本化最重要的部分。当然，如果你正在看的代码是 Haiku API 中所定义的标准，那么所有这些工作甚至都是不必要的。</p>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id9">实现脚本支持</a><a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>让您的程序对系统默认以外的脚本消息进行反馈将会让您的程序更为强大，并且会让您的程序产生意想不到的效果。根据所期望结果的不同，它们的实现可能需要或多或少的工作。我们将使用 ColorWell 控件为例来展示其应用。</p>
<p>为了实现额外的脚本支持，需要满足两个条件：对象必须是 BHandler 的子类，并且它需要实现 BHandler 的三个关键钩子函数：GetSupportedSuites()，MessageReceived()，以及ResolveSpecifier()。实际的步骤如下：</p>
<ul class="simple">
<li>创建一个 static property_info 结构体保存您的控件的 suite 的描述</li>
<li>实现 GetSupportedSuites()。</li>
<li>调整您的控件的 MessageReceived() 以测试带有说明符的消息，并且单独进行处理。</li>
<li>编写 ResolveSpecifier()。</li>
</ul>
<p>property_info 结构数组用于定义控件的脚本接口。结构体的定义如下：</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">struct</span> <span class="n">property_info</span>
<span class="p">{</span>
        <span class="c1">// 属性名称在结构体中的描述</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>

        <span class="c1">// 以 0 为结束符的支持命令列表。使用 0 作为首</span>
        <span class="c1">// 个命令以便作为通配符匹配所有命令。</span>
        <span class="n">uint32</span> <span class="n">commands</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

        <span class="c1">// 以 0 为结束符的支持说明符列表。使用 0 作为首个</span>
        <span class="c1">// 说明符以便作为通配符匹配所有说明符。</span>
        <span class="n">uint32</span> <span class="n">specifiers</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

        <span class="c1">// 描述属性的字符串</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">usage</span><span class="p">;</span>

        <span class="c1">// 可供自己使用的额外空间。系统不会对其进行处理。</span>
        <span class="n">uint32</span> <span class="n">extra_data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>对于我们的 ColorWell 类，我们定义四个属性：IsRound，布尔值，如果为真，则设置类型为圆形，否则则为矩形；还有三个整型属性：Red，Green 和 Blue。这三个属性支持获取和设置 ColorWell 颜色的单个色值。下面是最终的 suite 定义：</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">static</span> <span class="n">property_info</span> <span class="n">sColorWellProperties</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
        <span class="p">{</span>   <span class="s">&quot;IsRound&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">B_GET_PROPERTY</span><span class="p">,</span> <span class="n">B_SET_PROPERTY</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
                <span class="p">{</span> <span class="n">B_DIRECT_SPECIFIER</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
                <span class="s">&quot;True if the color well is round, false if rectangular.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">{</span> <span class="n">B_BOOL_TYPE</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>   <span class="s">&quot;Red&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">B_GET_PROPERTY</span><span class="p">,</span> <span class="n">B_SET_PROPERTY</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span> <span class="n">B_DIRECT_SPECIFIER</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
                <span class="s">&quot;The red value for the color well.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">{</span> <span class="n">B_INT32_TYPE</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">{</span>   <span class="s">&quot;Green&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">B_GET_PROPERTY</span><span class="p">,</span> <span class="n">B_SET_PROPERTY</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span> <span class="n">B_DIRECT_SPECIFIER</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
                <span class="s">&quot;The green value for the color well.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">{</span> <span class="n">B_INT32_TYPE</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">{</span>   <span class="s">&quot;Blue&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">B_GET_PROPERTY</span><span class="p">,</span> <span class="n">B_SET_PROPERTY</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span> <span class="n">B_DIRECT_SPECIFIER</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
                <span class="s">&quot;The blue value for the color well.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">{</span> <span class="n">B_INT32_TYPE</span> <span class="p">}</span>
        <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>现在 suite 的定义已经完成了，那么 GetSupportedSuites() 就是小菜一碟。它只需要为给定的消息添加上 suite 的名称，添加静态的属性列表作为 BPropertyInfo 实例，然后返回父类的该函数版本。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">BHandler</span><span class="o">*</span>
<span class="n">ColorWell</span><span class="o">::</span><span class="n">ResolveSpecifier</span><span class="p">(</span><span class="n">BMessage</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">int32</span> <span class="n">index</span><span class="p">,</span>
                                                        <span class="n">BMessage</span><span class="o">*</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">int32</span> <span class="n">what</span><span class="p">,</span>
                                                        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">property</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">BPropertyInfo</span> <span class="n">propertyInfo</span><span class="p">(</span><span class="n">sColorWellProperties</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">FindMatch</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">property</span><span class="p">)</span>
                        <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">BControl</span><span class="o">::</span><span class="n">ResolveSpecifier</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span>
                                                                                <span class="n">property</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>不要担心该示例中的 BPropertyInfo 对象。该类所作的处理很少，它只是将 property_info 进行包装以提供方便的功能，其中最有用的就是 Flatten()，Unflatten()，和 FindMatch()。</p>
<p>在脚本接口的属性到您的控件之间的起到桥梁作用的就是 MessageReceived()。幸运的是，这段代码很简洁。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="kt">void</span>
<span class="n">ColorWell</span><span class="o">::</span><span class="n">MessageReceived</span><span class="p">(</span><span class="n">BMessage</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// 我们的ColorWell类不处理特殊的消息，因此如果</span>
        <span class="c1">// 一个消息没有说明符，我们只需要将其传递给父类处理即可。</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">HasSpecifiers</span><span class="p">())</span>
                <span class="n">BControl</span><span class="o">::</span><span class="n">MessageReceived</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

        <span class="c1">// 脚本依赖于回复的消息。</span>
        <span class="n">BMessage</span> <span class="nf">reply</span><span class="p">(</span><span class="n">B_REPLY</span><span class="p">);</span>

        <span class="c1">// 这些变量用于保存当前说明符的有关信息。</span>
        <span class="kt">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">B_ERROR</span><span class="p">;</span>
        <span class="n">int32</span> <span class="n">index</span><span class="p">;</span>
        <span class="n">BMessage</span> <span class="n">specifier</span><span class="p">;</span>
        <span class="n">int32</span> <span class="n">what</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">property</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">GetCurrentSpecifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">specifier</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="p">)</span>
                        <span class="o">!=</span> <span class="n">B_OK</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">BHandler</span><span class="o">::</span><span class="n">MessageReceived</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

        <span class="c1">// FindMatch() 搜索 property_info 数组，查找其中匹配消息</span>
        <span class="c1">// 中说明符的属性。它将会返回匹配到的元素的索引，如果未发现</span>
        <span class="c1">// 则返回 -1。</span>
        <span class="n">BPropertyInfo</span> <span class="nf">propInfo</span><span class="p">(</span><span class="n">sColorWellProperties</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">propInfo</span><span class="p">.</span><span class="n">FindMatch</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">specifier</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">property</span><span class="p">))</span>
        <span class="p">{</span>
                <span class="c1">// 下面的case语句是中间代码，它们可以让每个属性</span>
                <span class="c1">// 完成某些操作。例如MessageReceived() case语句，</span>
                <span class="c1">// 它将未识别到的属性传递给父类。</span>
                <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>     <span class="c1">// IsRound</span>
                <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">FindBool</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isRound</span><span class="p">)</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">SetStyle</span><span class="p">(</span><span class="n">isRound</span> <span class="o">?</span> <span class="nl">COLORWELL_ROUND_WELL</span> <span class="p">:</span>
                                                        <span class="n">COLORWELL_SQUARE_WELL</span><span class="p">);</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_GET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">reply</span><span class="p">.</span><span class="n">AddBool</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">,</span>
                                                        <span class="n">Style</span><span class="p">()</span> <span class="o">==</span> <span class="n">COLORWELL_ROUND_WELL</span><span class="p">);</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="c1">// Red</span>
                <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_SET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">int32</span> <span class="n">newValue</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">FindInt32</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="p">{</span>
                                        <span class="n">rgb_color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ValueAsColor</span><span class="p">();</span>
                                        <span class="n">color</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">newValue</span><span class="p">;</span>
                                        <span class="n">SetValue</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
                                        <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_GET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">rgb_color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ValueAsColor</span><span class="p">();</span>
                                <span class="n">reply</span><span class="p">.</span><span class="n">AddInt32</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="c1">//Green</span>
                <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_SET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">int32</span> <span class="n">newValue</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">FindInt32</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="p">{</span>
                                        <span class="n">rgb_color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ValueAsColor</span><span class="p">();</span>
                                        <span class="n">color</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">newValue</span><span class="p">;</span>
                                        <span class="n">SetValue</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
                                        <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_GET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">rgb_color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ValueAsColor</span><span class="p">();</span>
                                <span class="n">reply</span><span class="p">.</span><span class="n">AddInt32</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="c1">// Blue</span>
                <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_SET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">int32</span> <span class="n">newValue</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">FindInt32</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="p">{</span>
                                        <span class="n">rgb_color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ValueAsColor</span><span class="p">();</span>
                                        <span class="n">color</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">newValue</span><span class="p">;</span>
                                        <span class="n">SetValue</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
                                        <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_GET_PROPERTY</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">rgb_color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ValueAsColor</span><span class="p">();</span>
                                <span class="n">reply</span><span class="p">.</span><span class="n">AddInt32</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="n">B_OK</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">default</span><span class="o">:</span>
                        <span class="k">return</span> <span class="n">BControl</span><span class="o">::</span><span class="n">MessageReceived</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// 如果我们不能够处理其中的某个消息，我们需要</span>
        <span class="c1">// 添加错误条件。我们需要使用strerror来描述错误，</span>
        <span class="c1">// 并且清楚的表明发生的错误。</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">B_OK</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">reply</span><span class="p">.</span><span class="n">what</span> <span class="o">=</span> <span class="n">B_MESSAGE_NOT_USDERSTOOD</span><span class="p">;</span>
                <span class="n">reply</span><span class="p">.</span><span class="n">AddString</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="n">strerroe</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1">// 即便我们成功的处理消息，也要返回错误代码。</span>
        <span class="n">reply</span><span class="p">.</span><span class="n">AddInt32</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

        <span class="n">msg</span><span class="o">-&gt;</span><span class="n">SendReply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>根据您的控件所使用的类型，ResolveSpecifier() 可以很简短，也可以很长很复杂。该方法的目的就是确定哪个句柄用于接收和回应相应的消息。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">BHandler</span><span class="o">*</span> <span class="nf">ResolveSpecifier</span><span class="p">(</span><span class="n">BMessage</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">int32</span> <span class="n">index</span><span class="p">,</span>
                                                <span class="n">BMessage</span><span class="o">*</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">int32</span> <span class="n">what</span><span class="p">,</span>
                                                <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">property</span><span class="p">);</span>
</pre></div>
</div>
<p>msg 指针对应于所传递的脚本消息。specifier 包含了 index 索引指向的当前说明符。what 保存了 specifier 消息的 what 字段值，而 property 包含了目标属性的名称。</p>
<p>您的属性还可以使用其他的方法来回应脚本消息，并且实现 ResolveSpecifier() 的代码量直接取决于这些回应方式和操作。属性的第一种方法就是返回一个附属于其他的 BLooper。第二种为属性返回一个附属于与您的控件相同的 BLooper。第三种方法是返回一个由您的控件处理后的值，例如计算结果，或者您的控件方法的调用结果。</p>
<div class="section" id="resolvespecifier-1-looper">
<h3><a class="toc-backref" href="#id10">ResolveSpecifier()方法1：远程 Looper 中的处理程序</a><a class="headerlink" href="#resolvespecifier-1-looper" title="永久链接至标题">¶</a></h3>
<p>BApplication 使用该方法解析其 Window 属性。其不属于 Haiku 中 BApplication 的源代码。下面 BApplication 通过索引或者保留索引来处理窗口说明符。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">propInfo</span><span class="p">.</span><span class="n">FindMatch</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">case</span> <span class="nl">kWindowByIndex</span><span class="p">:</span>
                <span class="p">{</span>
                        <span class="n">int32</span> <span class="n">index</span><span class="p">;</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">specifier</span><span class="o">-&gt;</span><span class="n">FindInt32</span><span class="p">(</span><span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="k">break</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="n">B_REVERSE_INDEX_SPECIFIER</span><span class="p">)</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">CountWindows</span><span class="p">().</span><span class="n">index</span><span class="p">;</span>

                        <span class="n">BWindow</span><span class="o">*</span> <span class="n">window</span> <span class="o">=</span> <span class="n">WindowAt</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">message</span><span class="o">-&gt;</span><span class="n">PopSpecifier</span><span class="p">();</span>
                                <span class="n">BMessage</span><span class="p">(</span><span class="n">window</span><span class="p">).</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                                <span class="n">err</span> <span class="o">=</span> <span class="n">B_BAD_INDEX</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>在 BApplication 版本的该函数末尾是一个返回 NULL 的调用。这里的关键就是 PopSpecifier() 调用和 NULL 返回值。脚本消息将被传递给相应的消息处理函数（messenger），但是说明符将被去掉，以使目标免于再次解析消息，并且由于 BLooper 不再负责解析说明符，也就是目标 Blooper 将从此开始接手，因此函数将返回 NULL。</p>
</div>
<div class="section" id="resolvespecifier-2-looper">
<h3><a class="toc-backref" href="#id11">ResolveSpecifier()方法2：当前 Looper 中的处理函数</a><a class="headerlink" href="#resolvespecifier-2-looper" title="永久链接至标题">¶</a></h3>
<p>BView 会使用这种方法来解析其 View 属性。如果视图（view）具有子视图，它们显然属于同一个 looper。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="c1">// View 属性</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fFirstChild</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">B_NAME_NOT_FOUND</span><span class="p">;</span>
                <span class="n">replyMsg</span><span class="p">.</span><span class="n">AddString</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;This window doesn&#39;t have&quot;</span>
                                <span class="s">&quot;children.&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 根据所使用的方法，获取子视图</span>
        <span class="n">BView</span><span class="o">*</span> <span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">case</span> <span class="nl">B_INDEX_SPECIFIER</span><span class="p">:</span>
                <span class="p">{</span>
                        <span class="n">int32</span> <span class="n">index</span><span class="p">;</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">specifier</span><span class="o">-&gt;</span><span class="n">FindInt32</span><span class="p">(</span><span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="n">child</span> <span class="o">=</span> <span class="n">ChildAt</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="nl">B_REVERSE_INDEX_SPECIFIER</span><span class="p">:</span>
                <span class="p">{</span>
                        <span class="n">int32</span> <span class="n">rindex</span><span class="p">;</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">specifier</span><span class="o">-&gt;</span><span class="n">FindInt32</span><span class="p">(</span><span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rindex</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="n">child</span> <span class="o">=</span> <span class="n">ChindAt</span><span class="p">(</span><span class="n">CountChildren</span><span class="p">().</span><span class="n">rindex</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="nl">B_NAME_SPECIFIER</span><span class="p">:</span>
                <span class="p">{</span>
                        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">specifier</span><span class="o">-&gt;</span><span class="n">FindString</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                                <span class="n">child</span> <span class="o">=</span> <span class="n">FindView</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// 传递消息给合适的子视图...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">PopSpecifier</span><span class="p">();</span>
                <span class="k">return</span> <span class="n">child</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// .. 反之，如果未发现子视图</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">B_OK</span><span class="p">)</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">B_BAD_INDEX</span><span class="p">;</span>

        <span class="n">replyMsg</span><span class="p">.</span><span class="n">AddString</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span>
                <span class="s">&quot;Cannot find view at/with specified index/name.&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>尽管这种方法也调用 PopSpecifier() 以避免对相同的说明符进行重复处理，但它返回非 NULL 的值，这是因为目标 BHandler 属于初始化说明符解析的同一个 BLooper。</p>
</div>
<div class="section" id="resolvespecifier-3">
<h3><a class="toc-backref" href="#id12">ResolveSpecifier()方法3：解析</a><a class="headerlink" href="#resolvespecifier-3" title="永久链接至标题">¶</a></h3>
<p>多数说明符都会被接收它们的目标对象所解析，那么下述的将是最常用的解析说明符的方法。在下述实例中，您的控件将会返回自身。如果它不能够解析所有消息，该控件将会返回其父类版本的 ResolveSpecifier() 处理结果。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="n">BHandler</span><span class="o">*</span>
<span class="n">ColorWell</span><span class="o">::</span><span class="n">ResolveSpecifier</span><span class="p">(</span><span class="n">BMessage</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">int32</span> <span class="n">index</span><span class="p">,</span>
                                                                <span class="n">BMessage</span><span class="o">*</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">int32</span> <span class="n">what</span><span class="p">,</span>
                                                                <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">property</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">BPropertyInfo</span> <span class="n">propertyInfo</span><span class="p">(</span><span class="n">sColorWellProperties</span><span class="p">);</span>
        <span class="n">int32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="n">FindMatch</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span>
                                                                                <span class="n">property</span><span class="p">);</span>

        <span class="c1">// 如果该属性碰巧是ColorWell的列表中元素之一，将返回ColorWell对象。</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

        <span class="c1">// 如果我们到了下面这一步，也就意味着我们并未识别出它，</span>
        <span class="c1">// 因此我们将会返回继承过来版本的结果。</span>
        <span class="k">return</span> <span class="n">BControl</span><span class="o">::</span><span class="n">ResolveSpecifier</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">specifier</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span>
                                                                                <span class="n">property</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id13">思路总结</a><a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>结束了所有脚本相关的函数，我们基本上完成了一个完整的控件。如前所述，通过 hey 发送消息，就能够远程的改变它的颜色。那还有什么没有涉及到呢？我们将在下一节课中继续。</p>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id14">深入了解</a><a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li>单独的设定每个颜色需要很多工作量。能否有一种方法可以同时设置这三种颜色？</li>
<li>创建属性，使之利用 HSL（色调，饱和度，亮度）色彩模式来设置颜色。</li>
</ul>
</div>
</div>


          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; 版权所有 2015, Haiku Chinese Group.
      最后更新于 Aug 18, 2016.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>